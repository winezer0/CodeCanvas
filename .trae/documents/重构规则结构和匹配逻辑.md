# 重构规则结构和匹配逻辑

## 1. 概述

根据用户需求，我们需要重构规则结构和匹配逻辑，取消可信度设计，采用新的规则体系。

## 2. 当前结构分析

* **规则定义**: `FrameworkRuleDefinition` 包含 `Levels` 字段，键为 "L1", "L2", "L3"

* **匹配逻辑**: 按级别顺序处理，找到一个匹配就返回，置信度基于级别

* **匹配关系**: 旧逻辑中路径匹配是 OR 关系，内容匹配是 AND 关系

## 3. 新结构设计

### 3.1 数据结构变更

* **`FrameworkRuleDefinition`** → **`Framework`**: 重命名并修改结构

* **`Levels`** → **`Rules`**: 从映射改为切片，支持多条规则

* **`RuleSet`** → **`Rule`**: 新的规则结构体

* **`Contains`** → **`FileContents`**: 从字符串切片改为映射，支持多文件内容匹配

### 3.2 新结构体定义

```go
// Rule 表示一条完整的检测规则
type Rule struct {
    Paths        []string            `yaml:"paths,omitempty"`
    FileContents map[string][]string `yaml:"file_contents,omitempty"`
}

// Framework 整体定义
type Framework struct {
    Name     string `yaml:"name"`
    Type     string `yaml:"type"`
    Language string `yaml:"language"`
    Category string `yaml:"category"`
    Rules    []Rule `yaml:"rules"` // 多条规则，OR 关系
}
```

## 4. 匹配逻辑变更

### 4.1 规则内部逻辑关系

* **`Paths`**: 所有路径必须存在（AND 关系）

* **`FileContents`**: 所有文件必须存在且包含对应关键字（AND 关系）

* **`Paths`** **与** **`FileContents`**: 同时满足（AND 关系）

### 4.2 规则之间逻辑关系

* 多条规则之间是 OR 关系

* 任意一条规则匹配成功，即判定为框架存在

## 5. 重构步骤

### 5.1 修改模型定义

1. **修改** **`internal/model/types.go`**:

   * 移除旧的 `FrameworkRuleDefinition` 和 `RuleSet` 结构体

   * 添加新的 `Framework` 和 `Rule` 结构体

   * 更新相关元数据结构体

### 5.2 修改引擎实现

1. **修改** **`internal/engine/engine.go`**:

   * 更新 `CanvasEngine` 结构体字段

   * 修改规则加载逻辑，支持新的规则格式

   * 重写 `DetectFrameworks` 方法，实现新的匹配逻辑

   * 移除置信度相关代码

2. **修改** **`internal/engine/match.go`**:

   * 更新 `containsAllKeywords` 方法，支持大小写不敏感匹配

   * 添加辅助方法，用于检查路径是否存在

   * 添加辅助方法，用于检查文件内容是否满足要求

### 5.3 更新嵌入规则

1. **更新** **`internal/embeds/embeds.go`**:

   * 将嵌入的规则更新为新格式

   * 移除旧的级别结构，采用新的规则列表结构

### 5.4 更新测试用例

1. **更新** **`internal/engine/engine_rules_test.go`**:

   * 修改测试用例，使用新的规则格式

   * 验证新的匹配逻辑

2. **更新** **`internal/engine/engine_test.go`**:

   * 修改测试用例，适应新的结构体和逻辑

3. **更新** **`internal/embeds/embeds_test.go`**:

   * 更新嵌入规则的测试用例

## 6. 注意事项

* **路径分隔符**: 解析和匹配时自动将路径连接符统一转为 `/`，避免 Windows `\` 问题

* **关键字匹配**: 大小写不敏感，顺序无关

* **性能优化**:  1、保持文件索引的缓存机制，实现路径的快速匹配。2、 不对文件内容进行缓存，但对读取文件的大小做出限制，超过1MB的文件不进行读取。

* **规则修改**: 自动将旧规则修改为新的规则格式

## 7. 验证步骤

1. 运行单元测试，确保所有测试通过
2. 手动测试，验证框架检测功能正常工作
3. 检查生成的检测结果，确保格式正确

## 8. 预期结果

* 规则结构更加清晰，易于维护和扩展

* 匹配逻辑更加明确，避免了旧逻辑中的模糊性

* 取消了可信度设计，简化了结果分析

* 支持更灵活的规则配置，提高了检测精度

