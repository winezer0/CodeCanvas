# 规则体系扩展：新增 file_version 字段实现计划

## 1. 概述

根据用户需求，我们需要在规则体系中新增 `file_version` 字段，用于定义从特定文件中通过正则表达式提取版本号的方法。

## 2. 实现步骤

### 2.1 更新模型定义

**文件**: `internal/model/types.go`

- 在 `Rule` 结构体中新增 `FileVersion` 字段
- 字段类型: `map[string][]string`
- YAML 标签: `yaml:"file_version,omitempty"`

### 2.2 更新检测逻辑

**文件**: `internal/engine/engine.go`

- 在 `DetectFrameworks` 方法中新增版本提取逻辑
- 遍历规则的 `FileVersion` 映射
- 对于每个文件路径，读取文件内容
- 按顺序应用每个正则表达式，直到找到匹配的版本号
- 将提取的版本号赋值给 `DetectedItem` 的 `Version` 字段

### 2.3 重写版本提取辅助函数

**文件**: `internal/engine/match.go`

- 新增 `extractVersion` 函数，封装版本提取逻辑
- 参数: 文件内容、正则表达式列表
- 返回值: 提取的版本号或空字符串
- 移除旧函数 `extractVersionFromText` 和 `extractVersionFromPath`

### 2.4 更新测试用例

**文件**: `internal/engine/engine_test.go`

- 更新现有测试用例，验证版本提取功能
- 添加新的测试用例，覆盖不同场景下的版本提取

## 3. 详细设计

### 3.1 模型定义更新

```go
// Rule 表示一条完整的检测规则
type Rule struct {
    Paths        []string            `yaml:"paths,omitempty"`
    FileContents map[string][]string `yaml:"file_contents,omitempty"`
    FileVersion  map[string][]string `yaml:"file_version,omitempty"` // 新增
}
```

### 3.2 版本提取逻辑

```go
// 提取版本信息
version := ""
if len(rule.FileVersion) > 0 {
    // 遍历文件版本映射
    for filePath, patterns := range rule.FileVersion {
        // 查找匹配的文件
        matches, _ := matcher.FindFiles(filePath)
        if len(matches) > 0 {
            // 使用第一个匹配的文件
            matchPath := matches[0]
            content, err := getFileContent(matchPath)
            if err != nil {
                continue
            }
            // 按顺序尝试每个正则表达式
            for _, pattern := range patterns {
                extractedVersion := extractVersion(content, []string{pattern})
                if extractedVersion != "" {
                    version = extractedVersion
                    break
                }
            }
            // 如果找到版本，停止遍历
            if version != "" {
                break
            }
        }
    }
}
```

### 3.3 辅助函数实现

```go
// extractVersion 使用给定的正则表达式列表从文件内容中提取版本号
func extractVersion(content []byte, patterns []string) string {
    for _, pattern := range patterns {
        re, err := regexp.Compile(pattern)
        if err != nil {
            continue
        }
        matches := re.FindSubmatch(content)
        if len(matches) > 1 {
            return string(matches[1])
        }
    }
    return ""
}
```

## 4. 验证计划

1. **单元测试**: 运行 `internal/engine` 包的测试，确保所有测试通过
2. **集成测试**: 运行整个项目的测试，确保没有破坏现有功能
3. **手动测试**: 创建一个包含版本信息的测试项目，验证版本提取功能

## 5. 预期结果

- 规则体系支持通过 `file_version` 字段定义版本提取方法
- 框架识别时能够自动提取版本号
- 版本提取失败不影响框架识别
- 支持多个正则表达式的顺序匹配

## 6. 影响范围

- **模型层**: 新增 `FileVersion` 字段，不破坏现有结构
- **引擎层**: 新增版本提取逻辑，增强现有功能
- **规则文件**: 新增 `file_version` 配置选项，向下兼容

## 7. 风险评估

- **正则表达式性能**: 复杂的正则表达式可能影响检测性能
- **正则表达式准确性**: 不同框架的版本格式差异可能导致匹配失败
- **文件读取错误**: 目标文件不存在或无法读取可能导致版本提取失败

通过以上设计和实现，我们可以成功扩展规则体系，实现从特定文件中提取版本号的功能。